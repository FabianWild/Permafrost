<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
  <link rel="stylesheet" href="css/polarmap.css" />

  <script src="js/jquery.js"></script>
  <script src="	https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
  <script src="js/proj4.js"></script>
  <script src="js/proj4leaflet.js"></script>
  <script src="js/shp.js"></script>
  <script src="js/polarmap-src.js"></script>
  <script src="js/leaflet.shpfile.js"></script>

  <style>
    body {
    padding: 0px;
    margin: 0px;
    }

    #map {
    min-width: 1920px;
    min-height: 1350px;
    }

    .legend {
      position: bottomright;
      background-color: white;
      padding: 10px;
      font-size: 12px;
      line-height: 18px;
      color: #555555;
    }

    .legend-item {
      display: flex;
      align-items: center;
    }

    .legend-box {
      width: 12px;
      height: 12px;
      margin-right: 5px;
    }

    .legend-box--green {
      background-color: green;
    }

    .legend-box--yellow {
      background-color: yellow;
    }

    .legend-box--orange {
      background-color: orange;
    }

    .legend-box--blue {
      background-color: blue;
    }

  </style>
</head>

<body>

  <div id="map"></div>
  <div id="legend" class="legend"></div>
  
  <script>
     var resize = function () {
    $("#map").css({
      width: $(window).width(),
      height: $(window).height()
    });
  };

  $(document).ready(function () {
    // All the details specific to the custom tile layer.
    // Custom extent for our EPSG:3571-3576 tiles
    var extent = 11000000 + 9036842.762 + 667;
    var tileDetails = {
      code: 'EPSG:3573',
      proj4def: '+proj=laea +lat_0=90 +lon_0=-100 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs',
      origin: [-extent, extent],
      tilesURL: 'http://{s}.tiles.arcticconnect.ca/osm_3573/{z}/{x}/{y}.png',
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
      zoom: {
        min: 0,
        max: 10
      }
    };

    // Generate Resolutions Array from origin information.
    // maxResolution is map width/height (origin[1] - origin[0]) metres divided
    // by 256 pixels (size of zoom level 0 tile). All other zoom levels, or
    // resolutions, are a factor of that.
    var maxResolution = (tileDetails.origin[1] - tileDetails.origin[0]) / 256;
    var resolutions = [];
    for (var i = tileDetails.zoom.min; i <= tileDetails.zoom.max; i++) {
      resolutions.push(maxResolution / Math.pow(2, i));
    };

    // Create new CRS for EPSG:3573.
    // Proj4 definition string can be found online.
    var CRS = new L.Proj.CRS(tileDetails.code,
      tileDetails.proj4def, {
        origin: tileDetails.origin,
        resolutions: resolutions
      });

    

    var map = polarMap("map");
    // var map = L.map('map', {
    //   continuousWorld: true,
    //   minZoom: tileDetails.zoom.min,
    //   maxZoom: tileDetails.zoom.max,
    //   crs: CRS
    // });

    L.tileLayer(tileDetails.tilesURL, {
      attribution: tileDetails.attribution
    }).addTo(map);


    // Add layer control to switch between layers

  let layerControl = L.control.layers( {
  }).addTo(map);

  var Domain = L.shapefile("IRYP_v2_yedoma_domain", {
  });

  
  layerControl.addOverlay(Domain, "Yedoma Domain");

  var Confidence = L.shapefile("IRYP_v2_yedoma_confidence_downsample", {
    onEachFeature: function (feature, layer) {
            layer.on('click', function () {
              if (layer.feature && layer.feature.properties) {
                var properties = layer.feature.properties;
                var confidence = properties.confidence;
                var popupContent = "<h4>Confidence/Sicherheit: " + confidence + "</h4>";
                layer.bindPopup(popupContent).openPopup();
              }
            });
            if (layer.feature.properties.confidence == 'confirmed') {
              layer.setStyle({ fillColor: 'green', color: "green" });
            } else if (layer.feature.properties.confidence == 'likely') {
              layer.setStyle({ fillColor: 'yellow', color: "yellow" });
            } else if (layer.feature.properties.confidence == 'uncertain') {
              layer.setStyle({ fillColor: 'orange', color: "orange" });
            }
          }
  });

  
  layerControl.addOverlay(Confidence, "Yedoma Confidence Classification");

      
  var Permafrost = L.shapefile("permaice", {
    fillColor: 'grey', color: "grey"
  });

  
  layerControl.addOverlay(Permafrost, "Overall Permafrost Area");

  

   
    // Use standard Lat/Lng for markers, they will be reprojected to the
    // map's CRS automatically.
    var pp_icon = L.icon({
      iconUrl: 'icons/bison.png',
      iconAnchor: [16, 37],
      popupAnchor: [0, -37],
    });

    L.marker([68.516, 161.435], { icon: pp_icon }).addTo(map).bindPopup(`<h4>Pleistocene Park</h4>`).openPopup();

    map.setView([68.516, 161.435], 5);

    var legend = L.control({ position: 'bottomright' });
    // Create a legend
    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'legend');
      div.innerHTML =
        '<h4>Legend</h4>' +
        '<div class="legend-item">' +
        '<div class="legend-box legend-box--blue"></div>' +
        '<p>Yedoma Domain</p>' +
        '</div>' +
        '<div class="legend-item">' +
        '<div class="legend-box legend-box--green"></div>' +
        '<p>Confirmed</p>' +
        '</div>' +
        '<div class="legend-item">' +
        '<div class="legend-box legend-box--yellow"></div>' +
        '<p>Likely</p>' +
        '</div>' +
        '<div class="legend-item">' +
        '<div class="legend-box legend-box--orange"></div>' +
        '<p>Uncertain</p>' +
        '</div>';
      return div;
    };

    legend.addTo(map);

    // Keep map full-size
    $(window).on("resize", function () {
      resize();
      map.invalidateSize({
        debounceMoveend: true
      });
    });
    $(window).trigger("resize");
  });

  </script>
</body>
</html>